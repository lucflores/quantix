// ---------- Generador y datasource ----------
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ---------- Enums ----------
enum Role {
  ADMIN
  EMPLEADO
}

enum MovementKind {
  IN
  OUT
}

// ---------- Modelos base ----------
model User {
  id                 String   @id @default(uuid())
  email              String   @unique
  password           String
  role               Role     @default(EMPLEADO)
  active             Boolean  @default(true)
  mustChangePassword Boolean  @default(false)
  createdAt          DateTime @default(now())

  // relaciones
  passwordResets PasswordReset[]
}

model PasswordReset {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  token     String   @unique
  expiresAt DateTime
  used      Boolean  @default(false)
  createdAt DateTime @default(now())
}

// ---------- Inventario / Productos ----------
model Product {
  id        String   @id @default(uuid())
  sku       String   @unique
  name      String
  cost      Decimal  @db.Decimal(12, 2)
  price     Decimal  @db.Decimal(12, 2)
  stock     Decimal  @default(0) @db.Decimal(12, 2)
  minStock  Decimal  @default(0) @db.Decimal(12, 2)
  active    Boolean  @default(true)
  createdAt DateTime @default(now())

  // relaciones inversas
  movements     InventoryMovement[]
  purchaseItems PurchaseItem[]
  saleItems     SaleItem[]
}

model InventoryMovement {
  id          String       @id @default(uuid())
  productId   String
  product     Product      @relation(fields: [productId], references: [id])
  kind        MovementKind
  quantity    Decimal      @db.Decimal(12, 2)
  createdById String
  createdAt   DateTime     @default(now())
}

// ---------- Compras ----------
model Purchase {
  id          String   @id @default(uuid())
  supplier    String?
  createdById String
  createdAt   DateTime @default(now())

  items PurchaseItem[]
}

model PurchaseItem {
  id         String   @id @default(uuid())
  purchaseId String
  purchase   Purchase @relation(fields: [purchaseId], references: [id])

  productId String
  product   Product @relation(fields: [productId], references: [id])

  quantity Decimal @db.Decimal(12, 2)
  unitCost Decimal @db.Decimal(12, 2)
}

// ---------- Ventas ----------
model Sale {
  id          String        @id @default(uuid())
  createdById String
  createdAt   DateTime      @default(now())
  payment     PaymentMethod @default(EFECTIVO)
  customerId  String?
  customerRel Customer?     @relation("SaleCustomer", fields: [customerId], references: [id])
  customer    String?

  items SaleItem[]
}

model SaleItem {
  id     String @id @default(uuid())
  saleId String
  sale   Sale   @relation(fields: [saleId], references: [id])

  productId String
  product   Product @relation(fields: [productId], references: [id])

  quantity  Decimal @db.Decimal(12, 2)
  unitPrice Decimal @db.Decimal(12, 2)
}

enum PaymentMethod {
  EFECTIVO
  CTA_CTE
}

model Customer {
  id        String   @id @default(uuid())
  name      String
  email     String?  @unique
  phone     String?
  active    Boolean  @default(true)
  createdAt DateTime @default(now())

  sales    Sale[]    @relation("SaleCustomer")
  payments Payment[]
}

model Payment {
  id          String   @id @default(uuid())
  customerId  String
  amount      Decimal  @db.Decimal(12, 2) // monto pagado (positivo)
  method      String? // opcional: EFECTIVO/TRANSFERENCIA/etc.
  reference   String? // nro. de recibo/transacci√≥n
  date        DateTime @default(now())
  createdById String
  createdAt   DateTime @default(now())

  customer Customer @relation(fields: [customerId], references: [id])
}
