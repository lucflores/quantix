generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                 String          @id @default(uuid())
  email              String          @unique
  password           String
  role               Role            @default(EMPLEADO)
  active             Boolean         @default(true)
  createdAt          DateTime        @default(now())
  mustChangePassword Boolean         @default(false)
  passwordResets     PasswordReset[]
}

model PasswordReset {
  id        String   @id @default(uuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  used      Boolean  @default(false)
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id])
}

enum Unit {
  UNIT
  KG
  LT
  M
}

model Product {
  id        String   @id @default(uuid())
  sku       String   @unique
  name      String
  unit      Unit     @default(UNIT)
  step      Decimal  @db.Decimal(10, 3) @default(1.000) 
  cost      Decimal  @db.Decimal(12, 2) 
  price     Decimal  @db.Decimal(12, 2) 
  stock     Decimal  @default(0) @db.Decimal(14, 3) 
  minStock  Decimal  @default(0) @db.Decimal(14, 3) 
  active    Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  movements     InventoryMovement[]
  purchaseItems PurchaseItem[]
  saleItems     SaleItem[]

  @@index([active, name])
}

model InventoryMovement {
  id          String       @id @default(uuid())
  productId   String
  kind        MovementKind
  quantity    Decimal      @db.Decimal(12, 2)
  createdById String
  createdAt   DateTime     @default(now())
  product     Product      @relation(fields: [productId], references: [id])
}

model Purchase {
  id          String   @id @default(uuid())
  createdById String
  createdAt   DateTime @default(now())
  supplierId  String?
  supplierRel Supplier? @relation("PurchaseSupplier", fields: [supplierId], references: [id])

  items       PurchaseItem[]
}

model PurchaseItem {
  id         String   @id @default(uuid())
  purchaseId String
  productId  String
  quantity   Decimal  @db.Decimal(12, 2)
  unitCost   Decimal  @db.Decimal(12, 2)
  product    Product  @relation(fields: [productId], references: [id])
  purchase   Purchase @relation(fields: [purchaseId], references: [id])
}

model Sale {
  id          String        @id @default(uuid())
  customer    String?
  createdById String
  createdAt   DateTime      @default(now())
  customerId  String?
  payment     PaymentMethod @default(EFECTIVO)
  customerRel Customer?     @relation("SaleCustomer", fields: [customerId], references: [id])
  items       SaleItem[]
}

model SaleItem {
  id        String  @id @default(uuid())
  saleId    String
  productId String
  quantity  Decimal @db.Decimal(12, 2)
  unitPrice Decimal @db.Decimal(12, 2)
  product   Product @relation(fields: [productId], references: [id])
  sale      Sale    @relation(fields: [saleId], references: [id])
}

model Customer {
  id        String    @id @default(uuid())
  name      String
  email     String?   @unique
  phone     String?
  active    Boolean   @default(true)
  createdAt DateTime  @default(now())
  payments  Payment[]
  sales     Sale[]    @relation("SaleCustomer")
}

model Supplier {
  id        String    @id @default(uuid())
  name      String
  email     String?   @unique
  phone     String?
  cuit      String?   @unique // CUIT o ID Fiscal
  address   String?   // Dirección
  active    Boolean   @default(true)
  createdAt DateTime  @default(now())
  
  purchases Purchase[] @relation("PurchaseSupplier") // Relación con Compras
}

model Payment {
  id          String   @id @default(uuid())
  customerId  String
  amount      Decimal  @db.Decimal(12, 2)
  method      String?
  reference   String?
  date        DateTime @default(now())
  createdById String
  createdAt   DateTime @default(now())
  customer    Customer @relation(fields: [customerId], references: [id])
}

enum Role {
  ADMIN
  EMPLEADO
}

enum MovementKind {
  IN
  OUT
}

enum PaymentMethod {
  EFECTIVO
  CTA_CTE
}

model Transaction {
  id             String   @id @default(uuid())
  type           String   // "INGRESO" o "EGRESO"
  comprobanteUrl String?  // link a PDF o imagen
  comprobanteNum String?
  partner        String?  // cliente o proveedor
  amount         Decimal  @db.Decimal(12, 2)
  status         String   // "PENDIENTE", "PAGADO", etc.
  date           DateTime @default(now())
  createdAt      DateTime @default(now())
}
